<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Domo Cactus â€” Control de Siembra</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #0d1117;
  --surface: #161b22;
  --surface2: #21262d;
  --border: #30363d;
  --green: #3fb950;
  --green-dim: #1a4025;
  --green-glow: rgba(63,185,80,0.15);
  --amber: #d29922;
  --amber-dim: #3d2c00;
  --red: #f85149;
  --text: #e6edf3;
  --text-muted: #8b949e;
  --text-dim: #484f58;
  --radius: 12px;
  --radius-sm: 8px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Background texture */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    radial-gradient(ellipse 80% 60% at 20% 0%, rgba(63,185,80,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 100%, rgba(63,185,80,0.04) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ Layout â”€â”€ */
.app {
  position: relative;
  z-index: 1;
  display: grid;
  grid-template-columns: 280px 1fr;
  grid-template-rows: 60px 1fr;
  min-height: 100vh;
}

/* â”€â”€ Header â”€â”€ */
header {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  border-bottom: 1px solid var(--border);
  background: rgba(13,17,23,0.9);
  backdrop-filter: blur(12px);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 18px;
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-icon {
  width: 28px;
  height: 28px;
  background: var(--green);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.header-stats {
  display: flex;
  gap: 20px;
}

.stat-chip {
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

.stat-chip span {
  color: var(--green);
  font-weight: 500;
}

/* â”€â”€ Sidebar â”€â”€ */
aside {
  border-right: 1px solid var(--border);
  background: var(--surface);
  overflow-y: auto;
  padding: 16px 12px;
  height: calc(100vh - 60px);
  position: sticky;
  top: 60px;
}

.sidebar-title {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  padding: 0 8px;
  margin-bottom: 12px;
}

.grid-50 {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 5px;
}

.cavity-btn {
  aspect-ratio: 1;
  border: 1px solid var(--border);
  background: var(--surface2);
  border-radius: 6px;
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.cavity-btn:hover {
  border-color: var(--green);
  color: var(--green);
  background: var(--green-glow);
}

.cavity-btn.active {
  border-color: var(--green);
  background: var(--green-glow);
  color: var(--green);
  box-shadow: 0 0 0 1px var(--green);
}

.cavity-btn.has-data::after {
  content: '';
  position: absolute;
  top: 3px;
  right: 3px;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--green);
}

.cavity-btn.stale::after {
  background: var(--amber);
}

/* â”€â”€ Main content â”€â”€ */
main {
  padding: 24px;
  overflow-y: auto;
  height: calc(100vh - 60px);
}

.main-header {
  margin-bottom: 24px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

.cavity-title {
  font-family: 'Syne', sans-serif;
  font-size: 28px;
  font-weight: 800;
  letter-spacing: -1px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.cavity-badge {
  font-size: 13px;
  font-family: 'DM Mono', monospace;
  font-weight: 400;
  background: var(--green-dim);
  color: var(--green);
  padding: 4px 10px;
  border-radius: 20px;
  border: 1px solid var(--green);
}

.tabs {
  display: flex;
  gap: 4px;
  background: var(--surface);
  padding: 4px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

.tab-btn {
  padding: 6px 14px;
  font-size: 13px;
  font-family: 'DM Sans', sans-serif;
  font-weight: 500;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: transparent;
  color: var(--text-muted);
  transition: all 0.15s;
}

.tab-btn.active {
  background: var(--surface2);
  color: var(--text);
}

/* â”€â”€ Cards â”€â”€ */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  transition: border-color 0.2s;
}

.card:hover {
  border-color: var(--text-dim);
}

.card-label {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 10px;
}

.card-value {
  font-family: 'Syne', sans-serif;
  font-size: 22px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.card-sub {
  font-size: 12px;
  color: var(--text-muted);
}

.card-empty {
  font-size: 14px;
  color: var(--text-dim);
  font-style: italic;
}

/* â”€â”€ Forms â”€â”€ */
.form-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 16px;
}

.form-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}

.form-section-header:hover {
  background: var(--surface2);
}

.form-section-title {
  font-family: 'Syne', sans-serif;
  font-weight: 600;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-icon {
  font-size: 16px;
}

.toggle-icon {
  color: var(--text-dim);
  font-size: 18px;
  transition: transform 0.2s;
}

.form-section.open .toggle-icon {
  transform: rotate(180deg);
}

.form-body {
  display: none;
  padding: 20px;
  gap: 12px;
  flex-direction: column;
}

.form-section.open .form-body {
  display: flex;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group label {
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
}

.form-group input,
.form-group textarea,
.form-group select {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  padding: 9px 12px;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  transition: border-color 0.15s;
  width: 100%;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--green);
}

.form-group textarea {
  resize: vertical;
  min-height: 72px;
}

.btn-primary {
  background: var(--green);
  color: #0d1117;
  border: none;
  border-radius: var(--radius-sm);
  padding: 10px 20px;
  font-family: 'Syne', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.15s;
  align-self: flex-start;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-primary:hover {
  background: #57d66b;
  transform: translateY(-1px);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-danger {
  background: transparent;
  color: var(--red);
  border: 1px solid var(--red);
  border-radius: var(--radius-sm);
  padding: 5px 10px;
  font-size: 11px;
  cursor: pointer;
  font-family: 'DM Mono', monospace;
  transition: all 0.15s;
}

.btn-danger:hover {
  background: rgba(248,81,73,0.1);
}

/* â”€â”€ Tables â”€â”€ */
.table-wrap {
  overflow-x: auto;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

thead th {
  background: var(--surface2);
  padding: 10px 14px;
  text-align: left;
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}

tbody tr:last-child {
  border-bottom: none;
}

tbody tr:hover {
  background: var(--surface2);
}

tbody td {
  padding: 10px 14px;
  color: var(--text);
}

/* â”€â”€ Status indicator â”€â”€ */
.status-dot {
  display: inline-block;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  margin-right: 6px;
}

.status-dot.green { background: var(--green); box-shadow: 0 0 4px var(--green); }
.status-dot.amber { background: var(--amber); box-shadow: 0 0 4px var(--amber); }
.status-dot.dim { background: var(--text-dim); }

/* â”€â”€ Toast â”€â”€ */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--surface);
  border: 1px solid var(--green);
  border-radius: var(--radius-sm);
  padding: 12px 18px;
  font-size: 13px;
  font-family: 'DM Mono', monospace;
  color: var(--green);
  z-index: 9999;
  transform: translateY(80px);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  display: flex;
  align-items: center;
  gap: 8px;
}

.toast.show {
  transform: translateY(0);
  opacity: 1;
}

/* â”€â”€ Empty state â”€â”€ */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-dim);
}

.empty-state .empty-icon {
  font-size: 40px;
  margin-bottom: 12px;
  opacity: 0.4;
}

.empty-state p {
  font-size: 13px;
  font-family: 'DM Mono', monospace;
}

/* â”€â”€ Chart bar (growth visual) â”€â”€ */
.growth-chart {
  display: flex;
  align-items: flex-end;
  gap: 6px;
  height: 80px;
  margin-top: 8px;
}

.growth-bar {
  flex: 1;
  background: var(--green-dim);
  border: 1px solid var(--green);
  border-radius: 3px 3px 0 0;
  position: relative;
  min-width: 16px;
  transition: height 0.3s ease;
  cursor: pointer;
}

.growth-bar:hover::after {
  content: attr(data-tip);
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--surface2);
  border: 1px solid var(--border);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  white-space: nowrap;
  font-family: 'DM Mono', monospace;
  color: var(--text);
  z-index: 10;
}

/* â”€â”€ Tabs content â”€â”€ */
.tab-content { display: none; }
.tab-content.active { display: block; }

/* â”€â”€ Responsive â”€â”€ */
@media (max-width: 768px) {
  .app {
    grid-template-columns: 1fr;
    grid-template-rows: 60px auto 1fr;
  }
  aside {
    height: auto;
    position: static;
    border-right: none;
    border-bottom: 1px solid var(--border);
    padding: 12px;
  }
  .grid-50 {
    grid-template-columns: repeat(10, 1fr);
  }
  main {
    height: auto;
  }
  .form-row {
    grid-template-columns: 1fr;
  }
}

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.tab-content.active {
  animation: fadeIn 0.2s ease forwards;
}
</style>
</head>
<body>

<div class="app">

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-icon">ğŸŒµ</div>
    Domo Cactus
  </div>
  <div class="header-stats">
    <div class="stat-chip"><span id="stat-sembradas">0</span> sembradas</div>
    <div class="stat-chip"><span id="stat-regadas">0</span> regadas hoy</div>
    <div class="stat-chip"><span id="stat-libre">50</span> libres</div>
  </div>
</header>

<!-- Sidebar -->
<aside>
  <div class="sidebar-title">Cavidades</div>
  <div class="grid-50" id="gridCavidades"></div>
</aside>

<!-- Main -->
<main>
  <div class="main-header">
    <div>
      <div class="cavity-title">
        <span id="titleCavidad">Cavidad 1</span>
        <span class="cavity-badge" id="badgeEstado">VacÃ­a</span>
      </div>
      <div style="font-size:13px;color:var(--text-muted);margin-top:4px;" id="subtitleEspecie">Sin siembra registrada</div>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('resumen', this)">Resumen</button>
      <button class="tab-btn" onclick="switchTab('siembra', this)">Siembra</button>
      <button class="tab-btn" onclick="switchTab('riego', this)">Riego</button>
      <button class="tab-btn" onclick="switchTab('crecimiento', this)">Crecimiento</button>
    </div>
  </div>

  <!-- TAB: Resumen -->
  <div id="tab-resumen" class="tab-content active">
    <div class="cards" id="resumenCards"></div>
    <div id="resumenHistorial"></div>
  </div>

  <!-- TAB: Siembra -->
  <div id="tab-siembra" class="tab-content">
    <div class="form-section open">
      <div class="form-section-header" onclick="toggleSection(this)">
        <div class="form-section-title"><span class="form-icon">ğŸŒ±</span> Registro de Siembra</div>
        <span class="toggle-icon">â–¾</span>
      </div>
      <div class="form-body">
        <div class="form-row">
          <div class="form-group">
            <label>Especie</label>
            <input type="text" id="especie" placeholder="ej. Echinocactus grusonii">
          </div>
          <div class="form-group">
            <label>Variedad</label>
            <input type="text" id="variedad" placeholder="opcional">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Fecha de Siembra</label>
            <input type="date" id="fechaSiembra">
          </div>
          <div class="form-group">
            <label>Cantidad de Semillas</label>
            <input type="number" id="semillas" placeholder="ej. 5" min="1">
          </div>
        </div>
        <div class="form-group">
          <label>Sustrato</label>
          <input type="text" id="sustrato" placeholder="ej. Arena + perlita 60/40">
        </div>
        <div class="form-group">
          <label>Notas</label>
          <textarea id="notasSiembra" placeholder="Condiciones iniciales, origen de las semillas..."></textarea>
        </div>
        <button class="btn-primary" onclick="guardarSiembra()">
          <span>âœ“</span> Guardar Siembra
        </button>
      </div>
    </div>
  </div>

  <!-- TAB: Riego -->
  <div id="tab-riego" class="tab-content">
    <div class="form-section open">
      <div class="form-section-header" onclick="toggleSection(this)">
        <div class="form-section-title"><span class="form-icon">ğŸ’§</span> Nuevo Riego</div>
        <span class="toggle-icon">â–¾</span>
      </div>
      <div class="form-body">
        <div class="form-row">
          <div class="form-group">
            <label>Fecha</label>
            <input type="date" id="fechaRiego">
          </div>
          <div class="form-group">
            <label>Cantidad (ml)</label>
            <input type="number" id="mlRiego" placeholder="ej. 50" min="0">
          </div>
        </div>
        <div class="form-group">
          <label>Observaciones</label>
          <textarea id="obsRiego" placeholder="Estado de la tierra, aspecto de la planta..."></textarea>
        </div>
        <button class="btn-primary" onclick="guardarRiego()">
          <span>ğŸ’§</span> Registrar Riego
        </button>
      </div>
    </div>
    <div id="tablaRiegos"></div>
  </div>

  <!-- TAB: Crecimiento -->
  <div id="tab-crecimiento" class="tab-content">
    <div class="form-section open">
      <div class="form-section-header" onclick="toggleSection(this)">
        <div class="form-section-title"><span class="form-icon">ğŸ“</span> Nueva MediciÃ³n</div>
        <span class="toggle-icon">â–¾</span>
      </div>
      <div class="form-body">
        <div class="form-row">
          <div class="form-group">
            <label>Fecha</label>
            <input type="date" id="fechaCrecimiento">
          </div>
          <div class="form-group">
            <label>TamaÃ±o (cm)</label>
            <input type="number" id="tamano" placeholder="ej. 2.5" step="0.1" min="0">
          </div>
        </div>
        <div class="form-group">
          <label>Observaciones</label>
          <textarea id="obsCrecimiento" placeholder="Aspecto, color, anomalÃ­as..."></textarea>
        </div>
        <button class="btn-primary" onclick="guardarCrecimiento()">
          <span>ğŸ“</span> Registrar MediciÃ³n
        </button>
      </div>
    </div>
    <div id="tablaCrecimiento"></div>
  </div>

</main>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Data
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let domo = JSON.parse(localStorage.getItem("domoCactusV2")) || {};
let currentCavidad = 1;

function saveData() {
  localStorage.setItem("domoCactusV2", JSON.stringify(domo));
}

function getCavidad(id) {
  if (!domo[id]) {
    domo[id] = { siembra: null, riegos: [], crecimiento: [] };
  }
  return domo[id];
}

function today() {
  return new Date().toISOString().split("T")[0];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Toast
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg, icon = "âœ“") {
  const t = document.getElementById("toast");
  t.innerHTML = `<span>${icon}</span> ${msg}`;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove("show"), 2500);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sidebar grid
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGrid() {
  const grid = document.getElementById("gridCavidades");
  grid.innerHTML = "";
  for (let i = 1; i <= 50; i++) {
    const btn = document.createElement("button");
    btn.className = "cavity-btn";
    btn.textContent = i;
    btn.dataset.id = i;
    const cav = domo[i];
    if (cav && cav.siembra) {
      btn.classList.add("has-data");
      // Check if watered recently (last 7 days)
      if (cav.riegos && cav.riegos.length) {
        const last = new Date(cav.riegos[cav.riegos.length - 1].fecha);
        const diff = (Date.now() - last) / 86400000;
        if (diff > 7) btn.classList.add("stale");
      }
    }
    if (i === currentCavidad) btn.classList.add("active");
    btn.onclick = () => selectCavidad(i);
    grid.appendChild(btn);
  }
  updateHeaderStats();
}

function updateHeaderStats() {
  let sembradas = 0;
  let regadasHoy = 0;
  for (let i = 1; i <= 50; i++) {
    const c = domo[i];
    if (c && c.siembra) sembradas++;
    if (c && c.riegos) {
      const t = today();
      if (c.riegos.some(r => r.fecha === t)) regadasHoy++;
    }
  }
  document.getElementById("stat-sembradas").textContent = sembradas;
  document.getElementById("stat-regadas").textContent = regadasHoy;
  document.getElementById("stat-libre").textContent = 50 - sembradas;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Select cavity
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectCavidad(id) {
  currentCavidad = id;
  document.querySelectorAll(".cavity-btn").forEach(b => {
    b.classList.toggle("active", parseInt(b.dataset.id) === id);
  });
  document.getElementById("titleCavidad").textContent = "Cavidad " + id;
  renderAll();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("tab-" + name).classList.add("active");
  btn.classList.add("active");
  if (name === "riego") renderTablaRiegos();
  if (name === "crecimiento") renderTablaCrecimiento();
}

function toggleSection(header) {
  header.parentElement.classList.toggle("open");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Save functions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function guardarSiembra() {
  const cav = getCavidad(currentCavidad);
  const esp = document.getElementById("especie").value.trim();
  if (!esp) { showToast("Ingresa la especie", "âš "); return; }
  cav.siembra = {
    especie: esp,
    variedad: document.getElementById("variedad").value.trim(),
    fecha: document.getElementById("fechaSiembra").value || today(),
    semillas: parseInt(document.getElementById("semillas").value) || 1,
    sustrato: document.getElementById("sustrato").value.trim(),
    notas: document.getElementById("notasSiembra").value.trim()
  };
  saveData(); buildGrid(); renderAll();
  showToast("Siembra guardada en cavidad " + currentCavidad, "ğŸŒ±");
}

function guardarRiego() {
  const cav = getCavidad(currentCavidad);
  const fecha = document.getElementById("fechaRiego").value || today();
  cav.riegos.push({
    fecha,
    ml: document.getElementById("mlRiego").value || "",
    obs: document.getElementById("obsRiego").value.trim()
  });
  document.getElementById("fechaRiego").value = "";
  document.getElementById("mlRiego").value = "";
  document.getElementById("obsRiego").value = "";
  saveData(); buildGrid(); renderTablaRiegos(); updateResumen();
  showToast("Riego registrado", "ğŸ’§");
}

function guardarCrecimiento() {
  const cav = getCavidad(currentCavidad);
  const tam = parseFloat(document.getElementById("tamano").value);
  if (!tam) { showToast("Ingresa el tamaÃ±o", "âš "); return; }
  cav.crecimiento.push({
    fecha: document.getElementById("fechaCrecimiento").value || today(),
    tamano: tam,
    obs: document.getElementById("obsCrecimiento").value.trim()
  });
  document.getElementById("fechaCrecimiento").value = "";
  document.getElementById("tamano").value = "";
  document.getElementById("obsCrecimiento").value = "";
  saveData(); renderTablaCrecimiento(); updateResumen();
  showToast("MediciÃ³n registrada", "ğŸ“");
}

function eliminarRiego(idx) {
  const cav = getCavidad(currentCavidad);
  cav.riegos.splice(idx, 1);
  saveData(); buildGrid(); renderTablaRiegos(); updateResumen();
  showToast("Riego eliminado", "ğŸ—‘");
}

function eliminarCrecimiento(idx) {
  const cav = getCavidad(currentCavidad);
  cav.crecimiento.splice(idx, 1);
  saveData(); renderTablaCrecimiento(); updateResumen();
  showToast("MediciÃ³n eliminada", "ğŸ—‘");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  updateHeader();
  updateResumen();
  renderTablaRiegos();
  renderTablaCrecimiento();
  prefillDates();
}

function prefillDates() {
  const t = today();
  document.getElementById("fechaSiembra").value = t;
  document.getElementById("fechaRiego").value = t;
  document.getElementById("fechaCrecimiento").value = t;
}

function updateHeader() {
  const cav = getCavidad(currentCavidad);
  const badge = document.getElementById("badgeEstado");
  const sub = document.getElementById("subtitleEspecie");
  if (cav.siembra) {
    badge.textContent = "Con siembra";
    badge.style.background = "var(--green-dim)";
    badge.style.color = "var(--green)";
    badge.style.borderColor = "var(--green)";
    sub.textContent = cav.siembra.especie + (cav.siembra.variedad ? ` â€” ${cav.siembra.variedad}` : "");
  } else {
    badge.textContent = "VacÃ­a";
    badge.style.background = "rgba(72,79,88,0.3)";
    badge.style.color = "var(--text-dim)";
    badge.style.borderColor = "var(--text-dim)";
    sub.textContent = "Sin siembra registrada";
  }
}

function updateResumen() {
  const cav = getCavidad(currentCavidad);
  const cards = document.getElementById("resumenCards");
  const hist = document.getElementById("resumenHistorial");

  if (!cav.siembra) {
    cards.innerHTML = "";
    hist.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸª´</div><p>Esta cavidad estÃ¡ vacÃ­a.<br>Ve a la pestaÃ±a Siembra para comenzar.</p></div>`;
    return;
  }

  // Days since planting
  const diasSiembra = cav.siembra.fecha
    ? Math.floor((Date.now() - new Date(cav.siembra.fecha)) / 86400000)
    : "â€”";

  // Last watering
  const ultimoRiego = cav.riegos.length
    ? (() => {
        const last = cav.riegos[cav.riegos.length - 1];
        const diff = Math.floor((Date.now() - new Date(last.fecha)) / 86400000);
        return diff === 0 ? "Hoy" : diff === 1 ? "Ayer" : `Hace ${diff} dÃ­as`;
      })()
    : "Sin riegos";

  // Last size
  const ultimoTam = cav.crecimiento.length
    ? cav.crecimiento[cav.crecimiento.length - 1].tamano + " cm"
    : "Sin medir";

  cards.innerHTML = `
    <div class="card">
      <div class="card-label">DÃ­as desde siembra</div>
      <div class="card-value">${diasSiembra}</div>
      <div class="card-sub">${cav.siembra.fecha || "Fecha no definida"}</div>
    </div>
    <div class="card">
      <div class="card-label">Ãšltimo riego</div>
      <div class="card-value">${ultimoRiego}</div>
      <div class="card-sub">${cav.riegos.length} riegos totales</div>
    </div>
    <div class="card">
      <div class="card-label">TamaÃ±o actual</div>
      <div class="card-value">${ultimoTam}</div>
      <div class="card-sub">${cav.crecimiento.length} mediciones</div>
    </div>
    <div class="card">
      <div class="card-label">Semillas sembradas</div>
      <div class="card-value">${cav.siembra.semillas}</div>
      <div class="card-sub">${cav.siembra.sustrato || "Sustrato no definido"}</div>
    </div>
  `;

  // Mini growth chart
  let chartHTML = "";
  if (cav.crecimiento.length > 1) {
    const data = cav.crecimiento.slice(-12);
    const max = Math.max(...data.map(d => d.tamano));
    chartHTML = `
      <div class="card" style="margin-top:0">
        <div class="card-label">Curva de crecimiento</div>
        <div class="growth-chart">
          ${data.map(d => {
            const h = Math.round((d.tamano / max) * 100);
            return `<div class="growth-bar" style="height:${h}%" data-tip="${d.fecha}: ${d.tamano}cm"></div>`;
          }).join("")}
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:8px;font-family:'DM Mono',monospace;">
          ${data[0].fecha} â†’ ${data[data.length-1].fecha}
        </div>
      </div>
    `;
  }

  hist.innerHTML = chartHTML;
}

function renderTablaRiegos() {
  const cav = getCavidad(currentCavidad);
  const wrap = document.getElementById("tablaRiegos");
  if (!cav.riegos.length) {
    wrap.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ’§</div><p>Sin riegos registrados aÃºn.</p></div>`;
    return;
  }
  const rows = [...cav.riegos].reverse().map((r, idx) => {
    const realIdx = cav.riegos.length - 1 - idx;
    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:12px">${r.fecha}</td>
      <td>${r.ml ? r.ml + " ml" : "â€”"}</td>
      <td>${r.obs || "â€”"}</td>
      <td><button class="btn-danger" onclick="eliminarRiego(${realIdx})">âœ•</button></td>
    </tr>`;
  }).join("");
  wrap.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Fecha</th><th>Cantidad</th><th>Observaciones</th><th></th></tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function renderTablaCrecimiento() {
  const cav = getCavidad(currentCavidad);
  const wrap = document.getElementById("tablaCrecimiento");
  if (!cav.crecimiento.length) {
    wrap.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>Sin mediciones registradas aÃºn.</p></div>`;
    return;
  }
  const rows = [...cav.crecimiento].reverse().map((c, idx) => {
    const realIdx = cav.crecimiento.length - 1 - idx;
    const prev = realIdx > 0 ? cav.crecimiento[realIdx - 1].tamano : null;
    const delta = prev !== null ? (c.tamano - prev).toFixed(1) : null;
    const deltaHTML = delta !== null
      ? `<span style="color:${delta >= 0 ? 'var(--green)' : 'var(--red)'}">
          ${delta >= 0 ? "â–²" : "â–¼"} ${Math.abs(delta)} cm
         </span>`
      : "â€”";
    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:12px">${c.fecha}</td>
      <td><strong>${c.tamano} cm</strong></td>
      <td>${deltaHTML}</td>
      <td>${c.obs || "â€”"}</td>
      <td><button class="btn-danger" onclick="eliminarCrecimiento(${realIdx})">âœ•</button></td>
    </tr>`;
  }).join("");
  wrap.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Fecha</th><th>TamaÃ±o</th><th>Î” Cambio</th><th>Observaciones</th><th></th></tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildGrid();
renderAll();
</script>
</body>
</html>
